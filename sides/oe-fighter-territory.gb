#side OE-Fighter-Territory
#author oehpr
#seed 1
#color 555
#type Fighter
#hardware
  processor 15
  robot-sensor 10
  blaster 15 6 10
  engine .15
  energy 300 80
  solar-cells .04
  armor 300
  food-sensor 4 1
  constructor .75
  eater .8
#decoration 999 x

#code
#vector dest
new-dest:
  1 vread                          ; position
  2dup position v-                  ; diff form position
  1 type-population vs/            ; move territory by portion of pop
  v+ 2dup 1 vwrite
  1 type-population 50 * sqrt ;territory radius
  random-angle
  polar-to-rect
  v+
  swap world-width 3 - min 3 max
  swap world-height 3 - min 3 max
  
  dest!
  return

wait: ;<time>
  do 
    sync sync sync sync
  1 - dup while-loop drop
  return 

nav: ;<aggression> <target>
  position v-
  velocity 10 vs* v-
  2dup engine-velocity!
  norm * engine-power!
  return

#start
position 1 vwrite
new-dest^

; States
wander:
  autoconstruct
  dest position v- engine-velocity!
  0.3 engine-power!
  10 wait
  new-dest^
  seek& jump

seek:
  autoconstruct
  dest position v- engine-velocity!
  0.03 engine-power!

  30 periodic-food-sensor drop
  food-found defend& ifg

  energy 50 > if
    80 periodic-robot-sensor drop
    robot-found attack& ifg
  then

  sync sync sync sync
  dest position dist 5 > seek& ifg

  new-dest^
  seek& jump

defend:
  autoconstruct
  0.1 food-position nav^
  
  80 periodic-food-sensor drop
  food-found seek& nifg

  80 periodic-robot-sensor drop
  robot-found attack& ifg

  friendly-collision 0 > wander& ifg

  defend& jump

#vector jink
attack:
  autoconstruct

  robot-position position v-
  2dup unitize 3 vs* v-    ; keep some distance
  robot-velocity 13 vs* v+ ; compensate for target velocity
  velocity 10 vs* v-       ; compensate for our velocity
  jink v+                  ; random dodge vector
  2dup engine-velocity!
  norm 0.3 * engine-power!
  sync

  10 periodic-robot-sensor if
    robot-found seek& nifg
    robot-position robot-velocity lead-blaster
    1 random-angle polar-to-rect jink!
  then
  attack& jump

sit:
  15 wait^
  sync

seek jump
#end
